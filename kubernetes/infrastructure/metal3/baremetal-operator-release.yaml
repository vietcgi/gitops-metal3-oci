---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: baremetal-operator
  namespace: baremetal-operator-system
spec:
  interval: 30m
  dependsOn:
    - name: ironic
      namespace: baremetal-operator-system
  chart:
    spec:
      chart: baremetal-operator
      version: "0.8.*"
      sourceRef:
        kind: HelmRepository
        name: metal3
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # Enable all BMC drivers
    global:
      enable_ironic: true

    # Baremetal Operator configuration
    baremetaloperator:
      # Watch all namespaces for BareMetalHost resources
      watchAllNamespaces: true

      # Ironic endpoint (internal service)
      ironicEndpoint: "http://ironic.baremetal-operator-system.svc.cluster.local:6385/v1"

      # Inspector endpoint
      ironicInspectorEndpoint: "http://ironic-inspector.baremetal-operator-system.svc.cluster.local:5050/v1"

    # Controller configuration
    replicaCount: 1

    # Resource limits (suitable for OCI free tier)
    resources:
      limits:
        memory: 512Mi
        cpu: 500m
      requests:
        memory: 256Mi
        cpu: 100m

    # Enable webhooks for validation
    enableWebhook: true

    # Metrics
    metrics:
      enabled: true
      serviceMonitor:
        enabled: false  # Enable if using Prometheus Operator
