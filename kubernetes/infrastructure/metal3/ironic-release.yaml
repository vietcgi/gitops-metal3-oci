---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: metal3
  namespace: flux-system
spec:
  interval: 1h
  url: https://metal3.github.io/baremetal-operator/
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ironic
  namespace: baremetal-operator-system
spec:
  interval: 30m
  chart:
    spec:
      chart: ironic
      version: "0.8.*"
      sourceRef:
        kind: HelmRepository
        name: metal3
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # Ironic configuration
    global:
      enable_dnsmasq: true
      enable_pxe_boot: true

    # Network configuration for bare metal provisioning
    # This should match your provisioning network
    baremetaloperator:
      ironic:
        # External IP for bare metal nodes to reach Ironic
        # This will be the control plane's public IP
        provisioningIP: ""  # Set via ConfigMap or leave for auto-detect

        # DHCP range for provisioning network
        dhcpRange: "10.0.2.100,10.0.2.200"

        # Enable iPXE boot
        enablePxeBoot: true

    # Ironic images
    images:
      ironic:
        repository: quay.io/metal3-io/ironic
        tag: latest
      ironicInspector:
        repository: quay.io/metal3-io/ironic-inspector
        tag: latest

    # Resource limits (suitable for OCI free tier)
    resources:
      ironic:
        limits:
          memory: 2Gi
          cpu: 1000m
        requests:
          memory: 1Gi
          cpu: 500m
      inspector:
        limits:
          memory: 1Gi
          cpu: 500m
        requests:
          memory: 512Mi
          cpu: 250m

    # Persistence
    persistence:
      ironic:
        size: 10Gi
        storageClass: local-path
