---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: cilium-metrics
  namespace: monitoring
spec:
  selector:
    matchLabels:
      k8s-app: cilium
  namespaceSelector:
    matchNames:
    - kube-system
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
    relabelings:
    - sourceLabels: [__meta_kubernetes_pod_name]
      targetLabel: pod
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: tailscale-metrics
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: tailscale-operator
  namespaceSelector:
    matchNames:
    - tailscale
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
    relabelings:
    - sourceLabels: [__meta_kubernetes_pod_name]
      targetLabel: pod
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: network-alerts
  namespace: monitoring
spec:
  groups:
  - name: network.rules
    rules:
    - alert: HighNetworkLatency
      expr: avg by(instance) (histogram_quantile(0.99, rate(cilium_network_latency_seconds_bucket[5m]))) > 0.1
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "High network latency detected"
        description: "Network latency is above 100ms on {{ $labels.instance }}"
    
    - alert: HighCiliumDropRate
      expr: rate(cilium_drop_count_total[5m]) > 10
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High packet drop rate detected"
        description: "Cilium is dropping more than 10 packets per second on {{ $labels.instance }}"